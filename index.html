<!DOCTYPE html>
<html>
<head>
    <title>jsPsych Pipe 实验示例 (使用 Experiment ID)</title>
    <script src="https://unpkg.com/jspsych@7.3.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.3"></script>
    <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css">
    <style>
        .fixation-cross {
            font-size: 60px;
            text-align: center;
            line-height: 1;
        }
    </style>
</head>
<body></body>
<script>

    // 初始化 jsPsych
    const jsPsych = initJsPsych({
        display_element: document.body,
        // 设置实验结束时的回调函数
        on_finish: function() {
            saveDataToServer();
        }
    });

    // ----------------------------------------------------------------------
    // ⬇️ 关键数据保存函数：使用 experimentID 在 Body 中进行认证 ⬇️
    // ----------------------------------------------------------------------
    function saveDataToServer() {
        
        // ❗❗❗ 替换成您真实的 Experiment ID (不是 Secret Key) ❗❗❗
        const EXPERIMENT_ID = "UeAGhdixenAm"; 
        
        // 获取所有实验数据，并将其格式化为 JSON 字符串，作为 Body 的一部分
        const data_string = jsPsych.data.get().json();

        // 构造发送到 Pipe 服务器的 Body 结构
        const payload = {
            experimentID: EXPERIMENT_ID,
            // 可选：指定文件名，通常包含参与者ID或时间戳
            filename: `data_${EXPERIMENT_ID}_${Date.now()}.json`, 
            data: data_string // 放置您的核心实验数据
        };


        // 使用 fetch API 向 jsPsych Pipe 发送数据
        fetch("https://pipe.jspsych.org/api/data/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                // ⚠️ 注意：这里移除了 Pipe-Secret
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (response.ok) {
                // 数据发送成功后的处理
                alert("实验完成，数据已成功保存至 Pipe！感谢您的参与！");
            } else {
                // 数据发送失败的处理
                alert("数据保存失败，请联系研究人员。错误码：" + response.status + "。请切换回 Pipe-Secret 模式。");
            }
        })
        .catch(error => {
            console.error('Network Error:', error);
            alert("网络连接错误，数据可能未能保存。");
        });
    }

    // ----------------------------------------------------
    // ⬇️ 实验时间线定义 (与之前代码相同) ⬇️
    // ----------------------------------------------------

    let timeline = [];

    const welcome = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<h1>欢迎参加实验！</h1><p>指导语：看到红色，按 J 键；看到蓝色，按 K 键。<br>按任意键开始。</p>',
    };
    timeline.push(welcome);
    
    for (let i = 0; i < 10; i++) {
        const is_red = Math.random() < 0.5;
        const color = is_red ? '红色' : '蓝色';
        const correct_key = is_red ? 'j' : 'k'; 
        const stimulus_text = `<p style="font-size: 30px; color: ${is_red ? 'red' : 'blue'};">${color}</p>`;

        const fixation = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<div class="fixation-cross">+</div>',
            choices: "NO_KEYS",
            trial_duration: 500,
        };
        timeline.push(fixation);

        const trial = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: stimulus_text,
            choices: ['j', 'k'],
            data: {
                task_id: 'color_rt',
                correct_response: correct_key,
                stimulus_color: color
            },
            on_finish: function(data){
                data.correct = jsPsych.pluginAPI.compareKeys(data.response, data.correct_response);
                data.rt_ms = data.rt; 
            }
        };
        timeline.push(trial);
    }
    
    const debrief = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<h1>实验全部完成！</h1><p>感谢您的参与。请等待数据保存弹窗提示，并关闭本页面。</p>',
        choices: "NO_KEYS",
        trial_duration: 3000,
    };
    timeline.push(debrief);

    // 运行实验
    jsPsych.run(timeline);
</script>
</html>
